## 说明

> 本脚本仅适用于自用，敬请外部人员不要使用，谢谢。
> 
> 本脚本是用于监控网页API请求并在新窗口中显示详细信息的工具，支持监控fetch和XMLHttpRequest请求、控制台日志捕获以及本地存储查看等功能。
> 
> **重要提示：** 使用前请仔细阅读本说明文档，确保理解所有功能和配置要求。本脚本涉及网络请求数据的捕获和存储，请务必注意信息安全。

## 1. 安装

> 取自知乎《[Tampermonkey油猴插件——安装与使用教程](https://zhuanlan.zhihu.com/p/128453110)》一文，不明白可以点击链接直接跳转。

### 1.1 介绍

相信熟悉浏览器的都知道，尤其是大名鼎鼎的Chrome浏览器，丰富的扩展程序让很多人体验到了浏览器的神奇之处，而一个没有安装扩展程序的浏览器也是不完整的。

而在众多的扩展中，就不得不提到一个浏览器插件——**Tampermonkey**。中文俗称油猴。

相信很多人也听说过，大家可以把他理解为一个用户脚本管理器。它本身是无法为我们发挥什么作用的，它主要依靠各大社区编写的扩展脚本（JavaScript代码）运行在浏览器上，来改变被访问网页的功能，提升我们的网页浏览体验。

### 1.2 **插件安装**

方法一：

> ①直接百度手动搜索进入**[Tampermonkey官网](https://www.tampermonkey.net/)**。
> 
> Tampermonkey Stable为正式版，Tampermonkey Beta为测试版
> 
> 点击**下载**，页面跳转至Edge外接扩展商店的安装页面，我们直接**获取**安装就好了。
> 
> Edge以外的其他浏览器点击下载则会跳转至**[chrome 网上应用店](https://chrome.google.com/webstore/category/extensions)**，正常情况下咱们是打不开的，需要科学上网才可以打开。
> 
> ②或者，很多浏览器里也贴心的自带有相应的扩展市场，我们也可以直接在其扩展应用市场之类的地方直接安装。

方法二：

> 考虑到文明上网的普及问题，非Edge以外的其他浏览器，我们也可以在很多渠道获取Tampermonkey的crx文件，将下载下来的压缩包解压出来，其中类型为**CRX文件**就是接下来需要用到的安装文件。
> 
> 打开浏览器**设置，**打开**扩展程序**页面，或者直接搜索**Chrome://extensions/**进入。然后保持页面**开发者模式**的开启。找到被解压后的tampermonkey.crx文件，将其拖动到**扩展程序**页面，释放并同意完成安装。
> 
> 成功安装后会弹出这个窗口，页面右上角也会出现油猴扩展的logo。
> 
> 不同浏览器所支持的扩展及安装过程可能略有出入，这里呢就主要以我的情况来介绍，不过**理论上支持chrome内核的其他浏览器都是可以安装的。**

### 1.3 安装本脚本
~~1. 打开油猴扩展的管理面板~~
~~2. 点击「添加新脚本」按钮~~
~~3. 将`dev.js`文件的全部内容复制粘贴到编辑窗口中~~
~~4. 点击「文件」→「保存」或使用快捷键Ctrl+S保存脚本~~
~~5. 脚本将自动在配置的网站上运行~~

打开本页面,点击绿色的安装按钮，版本可能不一致，但是位置都是这里。我的是已经安装完成了，所以显示重新安装。
安装完后，大工告成

## 2. 功能说明

### 2.1 主要功能

该脚本提供以下主要功能：

1. **API请求监控**：
   - 监控fetch和XMLHttpRequest类型的API请求
   - 按关键字过滤需要监控的URL
   - 记录请求的完整信息（URL、方法、请求头、请求体、响应头、响应体、状态码、耗时等）
   - 在新窗口中展示请求列表和详细信息

2. **控制台日志捕获**：
   - 捕获页面的console.log、error、warn、info、debug等日志
   - 实时显示在监控窗口中
   - 按类型分类显示（不同颜色区分）

3. **本地存储查看**：
   - 查看LocalStorage内容
   - 查看SessionStorage内容
   - 查看Cookie内容
   - 支持数据展开/收缩查看

4. **历史记录保存**：
   - 自动保存最近100条API请求记录
   - 页面刷新后自动恢复历史记录
   - 支持清空历史记录

5. **状态提示**：
   - 显示监控状态图标（右上角）
   - 支持拖动位置调整
   - 显示呼吸动画效果

### 2.2 使用方式

1. **监控控制**：
   - 油猴菜单中选择「切换API监控」开始/停止监控
   - 开始监控后，右上角会显示监控状态图标
   - 点击状态图标可以快速查看监控窗口

2. **监控窗口操作**：
   - API请求标签页：显示监控到的API请求列表
   - 控制台日志标签页：显示捕获的控制台日志
   - LocalStorage标签页：查看本地存储内容
   - SessionStorage标签页：查看会话存储内容
   - Cookie标签页：查看Cookie内容

3. **API请求查看**：
   - 点击请求列表项查看详细信息
   - 再次点击可隐藏详情
   - 根据状态码显示不同背景色（成功绿色、错误红色、警告黄色）

4. **历史记录管理**：
   - 点击「清空历史」按钮清除所有请求记录
   - 历史记录会在页面刷新后自动恢复

5. **监控关键字配置**：
   - 油猴菜单中选择「配置监控URL关键字」
   - 输入多个关键字（用逗号分隔）
   - 系统将只监控包含这些关键字的URL

### 2.3 配置说明

1. **监控关键字配置**：
   - 通过油猴菜单的「配置监控URL关键字」进行设置
   - 默认关键字：has-pss-cw-local, hsa-pss-pw
   - 可以根据需要添加或修改关键字
   - 多个关键字用逗号分隔

2. **域名监控配置**：
   - 脚本默认在以下域名下运行：
     * 以24开头的IP地址（24.*）
     * ybj.shanxi.gov.cn/ybfw/*
     * 包含huaweicitycloud.com的域名
   - 可以在脚本头部的@include规则中修改适用域名

3. **存储说明**：
   - 使用GM_setValue和GM_getValue存储配置和历史记录
   - 最大保存100条请求历史记录
   - 按域名保存监控状态，不同域名可独立控制

## 3. 安全说明

1. **数据存储安全**：
   - 使用油猴脚本的存储API（GM_getValue/GM_setValue）
   - 所有数据存储在本地浏览器中
   - 不涉及网络传输，保障数据安全
   
2. **运行环境限制**：
   - 仅在指定网站上运行（@include配置）
   - 在document-start阶段开始执行，确保从页面加载开始监控
   - 使用严格模式（'use strict'）

3. **隐私保护**：
   - 监控数据仅保存在本地，不会上传到任何服务器
   - 历史记录会在本地保存，建议定期清理敏感信息

4. **使用建议**：
   - 在处理敏感信息的页面使用时需谨慎
   - 定期清空历史记录
   - 不要在公共设备上使用包含敏感操作的监控功能

## 4. 更新日志

### v1.8 (最新版)
- **功能增强**：
  * 在请求详情标题后添加复制按钮，方便快速复制完整请求信息
  * 将所有复制按钮图标统一更新为📄，提升视觉一致性
  * 优化复制功能实现，解决跨窗口复制权限问题

- **用户界面**：
  * 将alert提示替换为自动消失的现代化消息提示组件
  * 消息提示支持四种类型（success/error/warning/info）
  * 消息提示位置优化为页面上部中间，提升用户体验
  * 修改复制按钮样式为透明背景+灰色边框，优化悬停效果

- **错误修复**：
  * 修复"NotAllowedError: Document is not focused"复制错误
  * 修复状态图标在呼吸动画时向左移动的问题
  * 确保弹窗和消息提示显示在当前打开的监控窗口中

- **技术优化**：
  * 移除clipboard API依赖，改用更可靠的execCommand方式
  * 添加setTimeout确保DOM元素正确处理
  * 优化代码结构和格式，提升可读性

### v1.5
- **新增功能**：
  * 实现历史记录本地保存，页面刷新后自动恢复
  * 增加最大历史记录数量限制（100条）
  * 优化URL显示逻辑，从关键字开始显示更完整URL

- **用户界面**：
  * 将状态图标移动到右上角位置
  * 优化状态图标样式和动画效果
  * 改进请求列表和详情展示

- **技术优化**：
  * 增强错误处理和日志捕获
  * 优化内存使用
  * 改进代码结构和性能

### v1.0
- **基础功能**：
  * 支持监控fetch和XMLHttpRequest请求
  * 支持按关键字过滤监控URL
  * 捕获控制台日志
  * 查看本地存储内容

- **用户界面**：
  * 创建监控窗口和标签页
  * 实现请求列表和详情展示
  * 添加状态提示图标

- **技术特性**：
  * 使用GM_setValue/GM_getValue存储配置
  * 实现域名独立监控状态
  * 支持关键字配置功能